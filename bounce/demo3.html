
<!doctype html><title>Balls & Cubes</title>

<style>
    h6{
        position: absolute;
        top: 0;
    }
    aside{
        position: absolute;
        right: 0;
        bottom: 10%;
    }
</style>

<script src="vendor/three.js/three.min.js"></script>

<script src="vendor/tquery-bundle.js"></script>

<script src="vendor/physijs/physi.js"></script>
<script src="vendor/tquery.physijs.js"></script>

<script src="vendor/tquery.meshlambertmaterial.js"></script>

<script src='vendor/tquery.light.shadow.js'></script>

<script src='//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.6.0/underscore-min.js'></script>

<script src='sound.js'></script>

<body onkeydown="keyHandler(event);"><script>
    var cw   = tQuery.createWorld();
    var world   = cw.boilerplate({cameraControls: false}).start();

    cw.loop().hookOnRender(function(){
        tContainer.get(0).rotation.x += 0.005;
        tContainer.get(0).rotation.y += 0.005;
        tContainer.get(0).rotation.z += 0.005;
        // tContainer.get(0).computeBoundingBox();
    });

    world.tCamera().position.set( 70, 70, 120 );
    // world.tCamera().lookAt( world.tScene().position );
    world.tCamera().lookAt( {x: 0, y: 0, z: 0} );

    world.tRenderer().shadowMapEnabled  = true;
    world.tRenderer().shadowMapSoft     = true;
    world.tRenderer().setClearColorHex( 0xffffff, 1 );

    world.enablePhysics({
        pathWorker  : 'vendor/physijs/physijs_worker.js',
        xScene : {
            // stupid high for testing
            reportsize : 10000
        }
    });

    tQuery.createDirectionalLight().addTo(world)
        .position(20, 40, -15).color(0xffffff)
        .castShadow(true).shadowMap(512*2,512*2)
        .shadowCamera(60, -60, 60, -60, 20, 20)
        .shadowDarkness(0.7).shadowBias(.002)

    tQuery.createDirectionalLight().addTo(world)
        .position(-20, -40, 15).color(0xffffff)
        .castShadow(true).shadowMap(512*2,512*2)
        .shadowCamera(60, -60, 60, -60, 20, 20)
        .shadowDarkness(0.7).shadowBias(.002)

    tQuery.createDirectionalLight().addTo(world)
        .position(20, -40, 15).color(0xffffff)
        .castShadow(true).shadowMap(512*2,512*2)
        .shadowCamera(60, -60, 60, -60, 20, 20)
        .shadowDarkness(0.7).shadowBias(.002)

    tQuery.createDirectionalLight().addTo(world)
        .position(-20, 40, 15).color(0xffffff)
        .castShadow(true).shadowMap(512*2,512*2)
        .shadowCamera(60, -60, 60, -60, 20, 20)
        .shadowDarkness(0.7).shadowBias(.002)


    var texture = THREE.ImageUtils.loadTexture( "images/rocks.jpg" );
    texture.wrapS   = texture.wrapT = THREE.RepeatWrapping;
    texture.repeat.set( 3, 3 );

    var wallThickness = 0.5;
    var wallOpacity = 0.05;
    var wallBounce = 1;

    var container = new THREE.Object3D();
    
    
    var bottom  = tQuery.createCube(100, wallThickness, 100).addTo(container)
        .position(0, -10, 0)
        .setLambertMaterial({color: 0xffffff, transparent: true, opacity: wallOpacity}).map(texture).back()
        .receiveShadow(true)
    bottom.enablePhysics({
        mass    : 0,
        restitution : wallBounce
    });

    var roof  = tQuery.createCube(100, wallThickness, 100).addTo(container)
        .position(0, 90, 0)
        .setLambertMaterial({color: 0xffffff, transparent: true, opacity: wallOpacity}).map(texture).back()
        .receiveShadow(true)
    roof.enablePhysics({
        mass    : 0,
        restitution : wallBounce
    });

    var north  = tQuery.createCube(wallThickness, 100, 100).addTo(container)
        .position(-50, 40, 0)
        .setLambertMaterial({color: 0xffffff, transparent: true, opacity: wallOpacity}).map(texture).back()
        .receiveShadow(true)
    north.enablePhysics({
        mass    : 0,
        restitution : wallBounce
    });

    var east  = tQuery.createCube(100, 100, wallThickness).addTo(container)
        .position(0, 40, -50)
        .setLambertMaterial({color: 0xffffff, transparent: true, opacity: wallOpacity}).map(texture).back()
        .receiveShadow(true)
    east.enablePhysics({
        mass    : 0,
        restitution : wallBounce
    });

    var south  = tQuery.createCube(wallThickness, 100, 100).addTo(container)
        .position(50, 40, 0)
        .setLambertMaterial({color: 0xffffff, transparent: true, opacity: wallOpacity}).map(texture).back()
        .receiveShadow(true)
    south.enablePhysics({
        mass    : 0,
        restitution : wallBounce
    });

    var west  = tQuery.createCube(100, 100, wallThickness).addTo(container)
        .position(0, 40, 50)
        .setLambertMaterial({color: 0xffffff, transparent: true, opacity: wallOpacity}).map(texture).back()
        .receiveShadow(true)
    west.enablePhysics({
        mass    : 0,
        restitution : wallBounce
    });

    tContainer = new tQuery.Object3D(container);

    // var helper = new THREE.BoundingBoxHelper(container, 0xff0000);
    // helper.update();
    // scene.add(helper);

    world.add(tContainer);

    var audioBuffers = new Object();
    window.AudioContext = window.AudioContext || window.webkitAudioContext;
    var audioContext = new AudioContext();

    var bufferLoader = new BufferLoader(
        audioContext,
        {
            s0_0: "sounds/i0/s0.mp3",
            s0_1: "sounds/i0/s1.mp3",
            s0_2: "sounds/i0/s2.mp3",
            s0_3: "sounds/i0/s3.mp3",
            s0_4: "sounds/i0/s4.mp3",
            s0_5: "sounds/i0/s5.mp3",

            s1_0: "sounds/i1/s0.mp3",
            s1_1: "sounds/i1/s1.mp3",
            s1_2: "sounds/i1/s2.mp3",
            s1_3: "sounds/i1/s3.mp3",
            s1_4: "sounds/i1/s4.mp3",
            s1_5: "sounds/i1/s5.mp3",

            s2_0: "sounds/i2/s0.mp3",
            s2_1: "sounds/i2/s1.mp3",
            s2_2: "sounds/i2/s2.mp3",
            s2_3: "sounds/i2/s3.mp3",
            s2_4: "sounds/i2/s4.mp3",
            s2_5: "sounds/i2/s5.mp3",

            s3_0: "sounds/i3/s0.mp3",
            s3_1: "sounds/i3/s1.mp3",
            s3_2: "sounds/i3/s2.mp3",
            s3_3: "sounds/i3/s3.mp3",
            s3_4: "sounds/i3/s4.mp3",
            s3_5: "sounds/i3/s5.mp3",

            s4_0: "sounds/i4/s0.mp3",
            s4_1: "sounds/i4/s1.mp3",
            s4_2: "sounds/i4/s2.mp3",
            s4_3: "sounds/i4/s3.mp3",
            s4_4: "sounds/i4/s4.mp3",
            s4_5: "sounds/i4/s5.mp3",
        },
        finishedLoading
    );

    bufferLoader.load();

    function finishedLoading(bufferList) {
        for (var key in bufferList){
          audioBuffers[key] = bufferList[key];
        }
    }

    var cntr = 0;

    var cTexture    = THREE.ImageUtils.loadTexture( "images/plywood.jpg" );
    var spawnObject = function(type){
        var x = Math.random()*15-7.5;
        var y = Math.random() + getRandomInt(20, 29);

        // console.log([x, y, e.x, e.y]);

        // if(typeof e !== 'undefined'){
        //     x = 100 - (e.x / window.innerWidth * 200);
        //     y = 100 - (e.y / window.innerHeight * 200);
        //     console.log([x,y]);
        // }

        cntr++;
        console.log(cntr);
        // var restitution = 0.5 + Math.random();
        // var restitution = getRandomInt(7, 12) / 10;
        var restitution = document.getElementById('geo-restitution').value;

        console.log(restitution);

        if(type == 'sphere'){
            var obj = tQuery.createSphere(4,40,40);
        }else{
            var obj = tQuery.createCube(4,4,4);
        }
        var object  = obj.addTo(world)
        // var object  = tQuery.createCube(4,4,4).addTo(world)
            .rotation(Math.random()*Math.PI*2, Math.random()*Math.PI*2, Math.random()*Math.PI*2)
            .position(x, y, Math.random()*15-7.5)
            .setLambertMaterial().map(cTexture).back()
            .castShadow(true)
        object.enablePhysics({
            friction    : 1,
            restitution : restitution,
        });
        var nCollisions = 0;
        object.instrument = getRandomInt(0, 3);
        object.note = getRandomInt(0, 5);
        playSound(audioContext, audioBuffers["s" + object.instrument + "_" + object.note], 1, 0);

        switch(object.instrument){
            case 0 : 
                object.colors = [0x99003D, 0xB20047, 0xCC0052, 0xE6005C, 0xff0066, 0xFF1975];
                break;
            case 1 :
                object.colors = [0x761EA9, 0x8622C1, 0x9727D9, 0xa82bf1, 0xB140F2, 0xB955F4];
                break;
            case 2 :
                object.colors = [0x76981B, 0x8AB11F, 0x9ECA24, 0xB1E428, 0xc5fd2d, 0xCBFD42];
                break;
            case 3 :
                object.colors = [0x178598, 0x1B9BB2, 0x1EB1CB, 0x22C7E5, 0x26ddfe, 0x3CE0FE];
                break;
        }

        var color = object.colors[object.note];
        object.get(0).material.color.setHex( color );

        object.physics().addEventListener('collision', function(){
            var color = object.colors[object.note];
            object.get(0).material.color.setHex( color );
            // var colliColors = [0xcc8855, 0xbb9955, 0xaaaa55, 0x99bb55, 0x88cc55, 0x77dd55];
            // if( ++nCollisions < colliColors.length ){
            //     var color   = colliColors[nCollisions];
            //     object.get(0).material.color.setHex( color );
            // }

            // var new_rad = object.get(0).scale.x * 0.9;
            // object.get(0).scale.x = new_rad;
            // object.get(0).scale.y = new_rad;
            // object.get(0).scale.z = new_rad;
            // console.log(object.get(0));

            // object.note++;
            // if(object.note > 5)
            //     object.note = 0;

            object.note = getRandomInt(0, 5);

            
            playSound(audioContext, audioBuffers["s" + object.instrument + "_" + object.note], 1, 0);
        });

        return false;
    }
    // setInterval(spawnObject, 1000);
    function getRandomInt(min, max) {
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    keyHandler = function(e){
        if(e.keyCode == 66){
            spawnObject('sphere');
        }else if(e.keyCode == 67){
            spawnObject('cube');
        }
    };
</script>
<h6>Press <strong>C</strong> or <strong>B</strong></h6>
<aside>
<label for="geo-restitution">Object <a target="_blank" href="http://en.wikipedia.org/wiki/Coefficient_of_restitution">COR</a></label><input value="1" step="0.1" type="number" id="geo-restitution" name="geo-restitution">
</aside>
</body>