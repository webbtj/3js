
<!doctype html><title>Minimal tQuery Page</title>
<script src="vendor/tquery-bundle.js"></script>

<script src="vendor/physijs/physi.js"></script>
<script src="vendor/tquery.physijs.js"></script>

<script src="vendor/tquery.meshlambertmaterial.js"></script>

<script src='vendor/tquery.light.shadow.js'></script>

<script src='//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.6.0/underscore-min.js'></script>

<script src='sound.js'></script>

<body onkeydown="spawnObject();"><script>
    var world   = tQuery.createWorld().boilerplate({cameraControls: false}).start();

    world.tCamera().position.set( 70, 40, 70 );
    world.tCamera().lookAt( world.tScene().position );

    world.tRenderer().shadowMapEnabled  = true;
    world.tRenderer().shadowMapSoft     = true;
    world.tRenderer().setClearColorHex( 0xffffff, 1 );

    world.enablePhysics({
        pathWorker  : 'vendor/physijs/physijs_worker.js',
    });

    tQuery.createDirectionalLight().addTo(world)
        .position(20, 40, -15).color(0xffffff)
        .castShadow(true).shadowMap(512*2,512*2)
        .shadowCamera(60, -60, 60, -60, 20, 200)
        .shadowDarkness(0.7).shadowBias(.002)


    var texture = THREE.ImageUtils.loadTexture( "images/rocks.jpg" );
    texture.wrapS   = texture.wrapT = THREE.RepeatWrapping;
    texture.repeat.set( 3, 3 );
    
    
    var ground  = tQuery.createCube(100, 1, 100).addTo(world)
        .position(0, -10, 0)
        .setLambertMaterial().map(texture).back()
        .receiveShadow(true)
    ground.enablePhysics({
        mass    : 0,
        restitution : 1
    });

    var audioBuffers = new Object();
    window.AudioContext = window.AudioContext || window.webkitAudioContext;
    var audioContext = new AudioContext();

    var bufferLoader = new BufferLoader(
        audioContext,
        {
            s0_0: "sounds/i0/s0.mp3",
            s0_1: "sounds/i0/s1.mp3",
            s0_2: "sounds/i0/s2.mp3",
            s0_3: "sounds/i0/s3.mp3",
            s0_4: "sounds/i0/s4.mp3",
            s0_5: "sounds/i0/s5.mp3",

            s1_0: "sounds/i1/s0.mp3",
            s1_1: "sounds/i1/s1.mp3",
            s1_2: "sounds/i1/s2.mp3",
            s1_3: "sounds/i1/s3.mp3",
            s1_4: "sounds/i1/s4.mp3",
            s1_5: "sounds/i1/s5.mp3",

            s2_0: "sounds/i2/s0.mp3",
            s2_1: "sounds/i2/s1.mp3",
            s2_2: "sounds/i2/s2.mp3",
            s2_3: "sounds/i2/s3.mp3",
            s2_4: "sounds/i2/s4.mp3",
            s2_5: "sounds/i2/s5.mp3",

            s3_0: "sounds/i3/s0.mp3",
            s3_1: "sounds/i3/s1.mp3",
            s3_2: "sounds/i3/s2.mp3",
            s3_3: "sounds/i3/s3.mp3",
            s3_4: "sounds/i3/s4.mp3",
            s3_5: "sounds/i3/s5.mp3",

            s4_0: "sounds/i4/s0.mp3",
            s4_1: "sounds/i4/s1.mp3",
            s4_2: "sounds/i4/s2.mp3",
            s4_3: "sounds/i4/s3.mp3",
            s4_4: "sounds/i4/s4.mp3",
            s4_5: "sounds/i4/s5.mp3",
        },
        finishedLoading
    );

    bufferLoader.load();

    function finishedLoading(bufferList) {
        for (var key in bufferList){
          audioBuffers[key] = bufferList[key];
        }
    }

    var cTexture    = THREE.ImageUtils.loadTexture( "images/plywood.jpg" );
    var spawnObject = function(){
        var restitution = 1 + Math.random();
        var object  = tQuery.createSphere(4,40,40).addTo(world)
            .rotation(Math.random()*Math.PI*2, Math.random()*Math.PI*2, Math.random()*Math.PI*2)
            .position(Math.random()*15-7.5, 25, Math.random()*15-7.5)
            .setLambertMaterial().map(cTexture).back()
            .castShadow(true)
        object.enablePhysics({
            friction    : 3,
            restitution : restitution,
            // mass: 1
        });
        var nCollisions = 0;
        object.instrument = getRandomInt(0, 3);
        object.note = getRandomInt(0, 5);
        playSound(audioContext, audioBuffers["s" + object.instrument + "_" + object.note], 1, 0);
        object.physics().addEventListener('collision', function(){
            var colliColors = [0xcc8855, 0xbb9955, 0xaaaa55, 0x99bb55, 0x88cc55, 0x77dd55];
            if( ++nCollisions < colliColors.length ){
                var color   = colliColors[nCollisions];
                object.get(0).material.color.setHex( color );
            }

            
            playSound(audioContext, audioBuffers["s" + object.instrument + "_" + object.note], 1, 0);
        });

        return false;
    }
    // setInterval(spawnObject, 1000);
    function getRandomInt(min, max) {
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }
</script>

</body>